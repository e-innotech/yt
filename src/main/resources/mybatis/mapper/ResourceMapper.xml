<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yt.cms.mapper.ResourceMapper">
	<resultMap id="BaseResultMap" type="com.yt.cms.model.Resource">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="resourceName" property="resourceName" jdbcType="VARCHAR" />
		<result column="uri" property="uri" jdbcType="VARCHAR" />
		<result column="parent_id" property="parentId" jdbcType="INTEGER" />
		<result column="rw" property="rw" jdbcType="INTEGER" />
		<result column="isMenu" property="isMenu" jdbcType="INTEGER" />
	</resultMap>
	
	
		<resultMap id="ResourceResultMap" type="com.yt.cms.model.ResourceLevel1">
			<id column="id" property="id" jdbcType="INTEGER" />
			<result column="resourceName" property="resourceName" jdbcType="VARCHAR" />
			<result column="uri" property="uri" jdbcType="VARCHAR" />
			<result column="parent_id" property="parentId" jdbcType="INTEGER" />
			<result column="rw" property="rw" jdbcType="INTEGER" />
			<result column="isMenu" property="isMenu" jdbcType="INTEGER" />
			<result column="pname" property="pname" jdbcType="VARCHAR" />
			<collection property="level2" ofType="com.yt.cms.model.ResourceLevel2">
				<id column="l2_id" property="id" jdbcType="INTEGER" />
				<result column="l2_name" property="resourceName" jdbcType="VARCHAR" />
				<result column="l2_uri" property="uri" jdbcType="VARCHAR" />
				<result column="l2_parent_id" property="parentId" jdbcType="INTEGER" />
				<result column="l2_rw" property="rw" jdbcType="INTEGER" />
				<result column="l2_isMenu" property="isMenu" jdbcType="INTEGER" />
				<result column="l2_pname" property="pname" jdbcType="VARCHAR" />
				<collection property="level3" ofType="com.yt.cms.model.ResourceLevel3">
					<id column="l3_id" property="id" jdbcType="INTEGER" />
					<result column="l3_name" property="resourceName" jdbcType="VARCHAR" />
					<result column="l3_uri" property="uri" jdbcType="VARCHAR" />
					<result column="l3_parent_id" property="parentId" jdbcType="INTEGER" />
					<result column="l3_rw" property="rw" jdbcType="INTEGER" />
					<result column="l3_isMenu" property="isMenu" jdbcType="INTEGER" />
					<result column="l3_pname" property="pname" jdbcType="VARCHAR" />
				</collection>
			</collection>
	</resultMap>
	
	<resultMap id="ResultMap" type="com.yt.cms.model.Resource" extends="BaseResultMap">
		<result column="pname" property="pname" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap type="com.yt.cms.model.ResourceW" id="resourceW">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="uri" property="uri" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="Base_Column_List">
		id, resourceName, uri, parent_id, rw,isMenu
	</sql>
	
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from resource
		where id = #{id,jdbcType=INTEGER} and isDel = 0
	</select>
	
	<select id="queryAll" resultMap="ResourceResultMap">
		SELECT 
    a1.id,
    a1.resourceName,
    a1.uri,
    a1.parent_id,
    a1.rw,
    a1.isMenu,
    case when a1.parent_id =0 THEN '无'  end as pname,
    b1.id AS l2_id,
    b1.resourceName AS l2_name,
    b1.uri l2_uri,
    b1.parent_id AS l2_parent_id,
	b1.rw l2_rw,
    b1.isMenu l2_isMenu,
    (select d.resourceName from resource d where d.id = b1.parent_id) as l2_pname,
    
    c1.id l3_id,
	c1.resourceName l3_name,
    c1.uri l3_uri,
    c1.parent_id l3_parent_id,
    c1.rw l3_rw,
    c1.isMenu l3_isMenu,
    (select e.resourceName from resource e where e.id = c1.parent_id) as l3_pname
FROM
    (SELECT 
        a.*
    FROM
        resource a
    WHERE
        a.parent_id = 0 AND a.isDel = 0) a1
        LEFT JOIN
    (SELECT 
        b.*
    FROM
        resource b
    WHERE
        b.parent_id != 0 AND b.isDel = 0) b1 ON b1.parent_id = a1.id
        LEFT JOIN
    (SELECT 
        c.*
    FROM
        resource c
    WHERE
        c.parent_id != 0 AND c.isDel = 0) c1 ON b1.id = c1.parent_id
	
	</select>

	<!-- <select id="queryAll" resultMap="ResourceResultMap" >
	SELECT 
    d.id,
    d.resourceName,
    d.uri,
    d.parent_id,
    d.rw,
    d.isMenu,
    c.id AS l2_id,
    c.resourceName AS l2_name,
    c.uri l2_uri,
    c.parent_id AS l2_parent_id,
	c.rw l2_rw,
    c.isMenu l2_isMenu,
    n.id l3_id,
	n.resourceName l3_name,
    n.uri l3_uri,
    n.parent_id l3_parent_id,
    n.rw l3_rw,
    n.isMenu l3_isMenu
FROM
    (SELECT 
        b.*
    FROM
        resource b
    WHERE
        b.parent_id = 0 AND b.isDel = 0) d
        LEFT JOIN
    (SELECT 
        a.*
    FROM
        resource a
    WHERE
        a.parent_id != 0 AND a.isDel = 0) c ON c.parent_id = d.id
        LEFT JOIN
    (SELECT 
        m.*
    FROM
        resource m
    WHERE
        m.parent_id != 0 AND m.isDel = 0) n ON c.id = n.parent_id
	</select> -->

	<select id="query" resultMap="BaseResultMap" >
		select
		a.id, a.resourceName, a.uri, a.parent_id,case when b.resourceName is null THEN '无' else b.resourceName  end as pname, a.rw, a.isMenu
		from resource a 
		left join  resource b ON a.parent_id = b.id 
		where 1=1 and a.isDel = 0
			<if test="isMenu != null and isMenu != -1" >
			     and a.isMenu = #{isMenu,jdbcType=INTEGER}
	      	</if>
	      <if test="resourceName != null" >
	       and a.resourceName like concat('%', #{resourceName}, '%')
	      </if>
	      <if test="rw != null and rw != -1" >
			   and a.rw = #{rw,jdbcType=INTEGER}
	      </if>
	      <if test="uri != null" >
	       and a.uri like concat('%', #{uri}, '%')
	      </if>
	     order by a.id desc
	</select>

	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		delete from resource
		where id = #{id,jdbcType=INTEGER}
	</delete>

	<insert id="insertSelective" parameterType="com.yt.cms.model.Resource">
		<selectKey resultType="java.lang.Integer" order="AFTER"
			keyProperty="id">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into resource
		<trim prefix="(" suffix=")" suffixOverrides=",">

			<if test="resourceName != null">
				resourceName,
			</if>
			<if test="uri != null">
				uri,
			</if>
			<if test="parentId != null">
				parent_id,
			</if>
			<if test="rw != null">
				rw,
			</if>
			<if test="isMenu != null">
				isMenu,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">

			<if test="resourceName != null">
				#{resourceName,jdbcType=VARCHAR},
			</if>
			<if test="uri != null">
				#{uri,jdbcType=VARCHAR},
			</if>
			<if test="parentId != null">
				#{parentId,jdbcType=INTEGER},
			</if>
			<if test="rw != null">
				#{rw,jdbcType=INTEGER},
			</if>
			<if test="isMenu != null">
				#{isMenu,jdbcType=INTEGER},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.yt.cms.model.Resource">
		update resource
		<set>
			<if test="resourceName != null">
				resourceName = #{resourceName,jdbcType=VARCHAR},
			</if>
			<if test="uri != null">
				uri = #{uri,jdbcType=VARCHAR},
			</if>
			<if test="parentId != null">
				parent_id = #{parentId,jdbcType=INTEGER},
			</if>
			<if test="rw != null">
				rw = #{rw,jdbcType=INTEGER},
			</if>
			<if test="isMenu != null">
				isMenu = #{isMenu,jdbcType=INTEGER},
			</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>


	<update id="deleteLogicById" parameterType="java.lang.Integer">
		update resource
			set 
				isDel = 1, del_date = now()
		where id = #{id,jdbcType=INTEGER}
	</update>
	
	<select id="queryResource_W" resultMap="resourceW">
		  select a.id,a.uri from resource a where a.parent_id !=0 and a.rw = 1 and a.isDel = 0
	</select>
	
</mapper>